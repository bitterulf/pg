<html>
    <head>
        <script src="//unpkg.com/mithril/mithril.js"></script>
        <script src="/js/store.js"></script>
        <script src="/primus/primus.js"></script>
        <style>
            body {
                background-color: grey;
            }
        </style>
        <script>
            const primus = Primus.connect();

            const state = {
                userId: store.get('userId'),
                user: null,
                game: null
            };

            const App = {
                view: function() {
                    if (!state.userId) {
                        return m('button', {onclick: function() {
                            primus.emit('requestUserId');
                        }}, 'createUser');
                    }
                    else if (!state.user) {
                        return m('button', {onclick: function() {
                            primus.emit('login', state.userId);
                        }}, 'login');
                    }
                    else if (!state.game) {
                        return m('div', [
                            m('button', {onclick: function() {
                                primus.emit('createGame', 'game1');
                            }}, 'create game'),
                            m('button', {onclick: function() {
                                const token = prompt('Please insert join token:');
                                primus.emit('joinGame', token);
                            }}, 'join game')
                        ]);
                    }

                    const gameOwner = state.game.userId == state.user.userId;

                    return m('div', [
                        m('h1', 'game'),
                        m('h2', state.game.joinToken),
                        m('h2', 'players: ' + state.game.players.length + '/' + state.game.maxPlayers),
                        m('div', state.game.players.map(function(playerId) {
                            return m('div', playerId);
                        })),
                        gameOwner ? m('button', { onclick: function() { primus.emit('closeGame'); } }, 'close game') : ''
                    ]);
                }
            };

            primus.on('newUserId', function message(userId) {
                state.userId = userId;
                store.set('userId', userId);
                m.redraw();
            });
            primus.on('loggedIn', function message(user) {
                state.user = user;
                m.redraw();
            });
            primus.on('wrongUserId', function message() {
                alert('wrong user id');
                store.set('userId');
            });
            primus.on('alreadyInGame', function message() {
                alert('alreadyInGame!');
            });
            primus.on('updateGame', function message(game) {
                state.game = game;
                m.redraw();
            });
        </script>
        <title>pg</title>
    </head>
    <body>
        <div id='app'></div>
        <script>
            m.mount(document.querySelector('#app'), App)
        </script>
    </body>
</html>
